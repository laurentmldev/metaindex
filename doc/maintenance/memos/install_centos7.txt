

#Set timezone
sudo timedatectl set-timezone Europe/Paris

Create user
-----------

adduser mxadmin
passwd mxadminname
# gives sudo capabilities
usermod -aG wheel mxadminname

log as mxadminname

mkdir -p mx-maintenance/deliveries


# Sys config for ELK
# ----------------------------------------

# Configure VM mem alloc for ElasticSearch
vi /etc/sysctl.conf
> vm.max_map_count=262144
 
# max opened files
vi /etc/security/limits.conf
> nproc 4096
> <user>  -  nofile  65535

# disable swap : don't do it, it might make mysql (and other) DB unstable ?? 
# sudo swapoff -a, or
vi /etc/fstab
> comment lines with swap


# set HEAP size to about 50% of available ram
vi /etc/default/elasticsearch
> ES_HEAP_SIZE=2g
> MAX_LOCKED_MEMORY=unlimited
> MAX_OPEN_FILES=131070
# and then reboot


# update sshd config
# https://wiki.centos.org/HowTos/Network/SecuringSSH#head-3579222198adaf43a3ecbdc438ebce74da40d8ec]section
# ------------------

sudo vi /etc/ssh/sshd_config

>#Port 22
>Port xxxx

>#PermitRootLogin yes
>PermitRootLogin no

>AllowUsers mxadminname
>Protocol 2


>#X11Forwarding no
>X11Forwarding yes

># Banner none
>Banner /etc/sshbanner <-- file to create before with texts contents of the banner


sudo service sshd restart
# /!\ need to update firewall for the ssh being accessible again
# see next session


# update firewall
# ---------------

###
$ sudo vi /usr/lib/firewalld/services/ssh.xml
> <port protocol="tcp" port="22"/>
> <port protocol="tcp" port="2233"/>

###
$ sudo vi /etc/firewalld/services/phpmyadmin.xml
<?xml version="1.0" encoding="utf-8"?>
<service>
  <short>PHP MyAdmin</short>
  <description>Amdinistration of MySQL database for MetaindeX server</description>
  <port protocol="tcp" port="80"/>
</service>
$ firewall-cmd --permanent --add-service='phpmyadmin'

###
$ sudo vi /etc/firewalld/services/mxwebappftp.xml
<?xml version="1.0" encoding="utf-8"?>
<service>
  <short>MX WebApp FTP</short>
  <description>FTP access to MetaindeX userdata</description>
  <port protocol="tcp" port="25000-25200"/>
</service>
$ firewall-cmd --permanent --add-service='mxwebappftp'

###
$ sudo vi /etc/firewalld/services/mxwebappftp-passive.xml
<?xml version="1.0" encoding="utf-8"?>
<service>
  <short>MX WebApp FTP Passive</short>
  <description>FTP Passive-Mode access to MetaindeX userdata</description>
  <port protocol="tcp" port="45000-45200"/>
</service>
$ firewall-cmd --permanent --add-service='mxwebappftp-passive'

$ firewall-cmd --permanent --zone=public --change-interface=eth0
$ firewall-cmd --permanent --zone=public --list-all
public (active)
  target: default
  icmp-block-inversion: no
  interfaces: eth0
  sources: 
  services: dhcpv6-client mxwebappftp phpmyadmin ssh
  ports: 
  protocols: 
  masquerade: no
  forward-ports: 
  source-ports: 
  icmp-blocks: 
  rich rules: 
  
$ firewall-cmd --info-service=mxwebappftp
  
$ firewall-cmd --reload

Other install
-------------

# for htpasswd to generate Bcrypt passwords
sudo yum install httpd-tools
htpasswd -bnBC 10 "" password | tr -d ':\n'


Docker install 
--------------
curl -fsSL https://get.docker.com/ | sh
sudo usermod -aG docker mxadminname
sudo curl -L "https://github.com/docker/compose/releases/download/1.25.1/docker-compose-$(uname -s)-$(uname -m)" > /usr/bin/docker-compose
sudo chmod 755 /usr/bin/docker-compose


STARTUP
-------
sudo systemctl start docker
sudo docker-compose up





