
<VirtualHost *:80>
        ProxyPreserveHost On
        Redirect / https://localhost:${HTTPS_PORT}/webapp/loginform

</VirtualHost>
LogLevel notice
PassEnv HTTPD_SSL_CERTIFICATE_FILE
PassEnv HTTPD_SSL_CERTIFICATE_KEYFILE
<VirtualHost *:443>
        ServerName localhost
        
        SSLProxyEngine On		
	SSLEngine On
        RewriteEngine  on
        ProxyRequests Off
        ProxyPreserveHost On
        SSLCertificateFile ${HTTPD_SSL_CERTIFICATE_FILE}
	SSLCertificateKeyFile ${HTTPD_SSL_CERTIFICATE_KEYFILE}
	
        Redirect / https://localhost:${HTTPS_PORT}/webapp/loginform

        # offline message
        RewriteRule  /webapp/welcome.well-known/pki-validation/.* /cert-valid-file-check.txt 
        RewriteRule /offline.html /mxoffline.html
        RewriteRule /offline.pic /tools.svg
        ErrorDocument 500 https://localhost:${HTTPS_PORT}/offline.html
        ErrorDocument 501 https://localhost:${HTTPS_PORT}/offline.html
        ErrorDocument 502 https://localhost:${HTTPS_PORT}/offline.html
        ErrorDocument 503 https://localhost:${HTTPS_PORT}/offline.html
        ErrorDocument 504 https://localhost:${HTTPS_PORT}/offline.html
                
        # handle standard prospection requests
        RewriteRule /robots.txt /mxrobots.txt
        RewriteRule /ads.txt - [R=404,L]
	
	# redirect to main welcome page
        Redirect / https://localhost:${HTTPS_PORT}/webapp/loginform

        # redirect trash http requests into default MetaindeX page without 
        # disturbing main webapp server
        RewriteRule /webapp/welcome[^?].* - [R=404,L]
        RewriteRule /webapp/Tutorials[^?].* - [R=404,L]
	
        # ----------- PHP My Admin -------------
        # SSL tunnel for PHP MyAdmin
        ProxyPass /metaindex/pma http://mxpma:80
        ProxyPassReverse /metaindex/pma http://mxpma:80

        # SSL tunnel for kibana app
        ProxyPass /metaindex/kibana http://mxkibana:5601
        ProxyPassReverse /metaindex/kibana http://mxkibana:5601

        # ----------- Websockets -------------
        # When Upgrade:websocket header is present, redirect to ws        
        RewriteCond %{HTTP:UPGRADE} ^WebSocket$ [NC]
        RewriteCond %{HTTP:CONNECTION} Upgrade$ [NC]
        RewriteRule .* wss://mxwebapp:20000%{REQUEST_URI} [P]
        
        # ----------- Main webapp -------------
        # Forward to main webapp
        ProxyPass /webapp https://mxwebapp:20000/webapp
        ProxyPassReverse /webapp https://mxwebapp:20000/webapp

</VirtualHost>
